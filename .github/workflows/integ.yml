# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: integ
on:
  pull_request_target:
    types:
      - labeled
      - opened
      - synchronize
      - reopened
      - ready_for_review
  merge_group: {}
jobs:
  determine_env:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      env_name: ${{ steps.output.outputs.env_name }}
    steps:
      - name: Print event output for debugging in case the condition is incorrect
        run: cat $GITHUB_EVENT_PATH
      - name: Start requiring approval
        run: echo IntegTestCredentialsRequireApproval > .envname
      - name: If not from a fork, do not need approval
        if: "!github.pull_request.head.repo.fork"
        run: echo IntegTestCredentials > .envname
      - name: Output the value
        id: output
        run: echo "env_name=$(cat .envname)" >> "$GITHUB_OUTPUT"
  test:
    needs: determine_env
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    environment: ${{needs.targetenv.outputs.env_name}}
    steps:
      - name: Federate into AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: publib-integ-test
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16.16.0
          cache: yarn
      - name: Yarn install
        run: yarn install --frozen-lockfile
      - name: Run integration tests
        run: npx jest --testMatch "<rootDir>/test/**/*.integ.ts"
